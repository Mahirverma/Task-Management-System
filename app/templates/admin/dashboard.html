{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block head %}
<style>
/* General Page Styles */
.page-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 40px 0 20px 40px;
    color: #222;
}
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20px 40px;
}
.dashboard-header h2 {
    font-size: 1.5rem;
    color: #333;
}
.btn {
    padding: 10px 18px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s ease-in-out;
    cursor: pointer;
}
.btn-primary {
    background-color: #2f80ed;
    color: #fff;
}

.btn-primary:hover {
    background-color: #1366d6;
}
.btn-edit {
    background-color: #f9ca24;
    color: #222;
}

.btn-edit:hover {
    background-color: #f1b50a;
}

.btn-delete {
    background-color: #eb4d4b;
    color: #fff;
}

.btn-delete:hover {
    background-color: #ff3e3b;
    color: #fff;
}
.styled-table {
    width: 90%;
    margin: 20px auto 50px auto;
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    background-color: #fff;
}

.styled-table th, .styled-table td {
    padding: 14px 20px;
    text-align: left;
}

.styled-table thead {
    background-color: #1e2732;
    color: #fff;
    font-weight: 600;
    text-transform: uppercase;
}

.styled-table tbody tr {
    border-bottom: 1px solid #ddd;
    transition: background-color 0.2s ease-in-out;
}

.styled-table tbody tr:nth-of-type(even) {
    background-color: #f3f3f3;
}

.styled-table tbody tr:hover {
    background-color: #e1f0ff;
}

.styled-table tbody td a {
    margin-right: 8px;
}

/* Responsive */
@media (max-width: 900px) {
    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .dashboard-header h2 {
        margin-bottom: 10px;
    }

    .styled-table {
        width: 100%;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #4A90E2; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
  <div class="container-fluid">
    <!-- Page title on the left -->
    <a class="navbar-brand fw-bold" href="/admin/dashboard">Admin Dashboard</a>

    <!-- Right-aligned logout link -->
    <div class="collapse navbar-collapse justify-content-end" id="navbarContent">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-danger fw-bold" href="/logout">Logout</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="dashboard-header">
    <h2>Managers</h2>
    <a href="/admin/{{ current_user.id }}/create-manager" class="btn btn-primary">Create New Manager</a>
</div>

<table class="styled-table">
    <thead>
        <tr>
            <th>S. No.</th>
            <th>Manager Username</th>
            <th>Email</th>
            <th>Full Name</th>
            <th>Employees</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for manager in managers %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ manager.username }}</td>
            <td>{{ manager.email }}</td>
            <td>{{ manager.full_name }}</td>
            <td>
                {% if manager.employee_count > 0 %}
                    {{ manager.employee_count }} employees
                {% else %}
                    <span>No employees</span>
                {% endif %}
            </td>
            <td>
                <a href="/admin/{{ current_user.id }}/managers/{{ manager.uuid }}" class="btn btn-edit">View</a>
                <button class="btn btn-delete" onclick="deactivateManager('{{ current_user.id }}', '{{ manager.uuid }}')"> Delete </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="dashboard-header">
    <h2>Employees</h2>
</div>
<table class="styled-table">
    <thead>
        <tr>
            <th>S. No.</th>
            <th>Employee Username</th>
            <th>Email</th>
            <th>Full Name</th>
            <th>Tasks</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for emp in employees %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ emp.username }}</td>
            <td>{{ emp.email }}</td>
            <td>{{ emp.full_name }}</td>
            <td>
                {% if emp.task_count > 0 %}
                    {{ emp.task_count }} tasks
                {% else %}
                    <span>No Tasks</span>
                {% endif %}
            </td>
            <td>
                <a href="/manager/{{ emp.manager_id }}/employees/{{ emp.uuid }}" class="btn btn-edit">View</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="dashboard-header">
    <h2>Tasks</h2>
</div>
<table class="styled-table">
    <thead>
        <tr>
            <th>S. No.</th>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>Created By</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for t in tasks %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ t.title }}</td>
            <td>{{ t.description }}</td>
            <td>{{ t.status }}</td>
            <td>{{ t.created_by_name }} </td>
            <td>
                <a href="/manager/{{ t.created_by_id }}/tasks/ {{ t.id }}" class="btn btn-edit">View</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="dashboard-header">
    <h2>Task History</h2>
</div>
<table class="styled-table">
    <thead>
        <tr>
            <th>S. No.</th>
            <th>Task Name</th>
            <th>Status</th>
            <th>Activity Time</th>
        </tr>
    </thead>
    <tbody>
        {% for t in task_log %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ t.task_name }}</td>
            <td>{{ t.status }}</td>
            <td>{{ t.timestamp }} </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
async function deactivateManager(adminId, managerId) {
    if (!confirm("Are you sure you want to deactivate this manager?")) return;

    const res = await fetch(`/admin/${adminId}/users/${managerId}/deactivate`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" }
    });

    if (res.ok) {
        // Refresh the page or remove the row dynamically
        location.reload();
    } else {
        const data = await res.json();
        alert("Error: " + data.detail);
    }
}
</script>
{% endblock %}